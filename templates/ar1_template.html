{% extends "base_report.html" %}

{% block content %}
<header class="report-header">
    <h1>{{ report_title }}</h1>
    <p><strong>Variant:</strong> {{ variant_label }} <span class="muted">({{ variant_key }})</span></p>
    <p><strong>Comparison:</strong> {{ give_conditions|join(', ') }} vs {{ hug_conditions|join(', ') }}</p>
    {% if variant_description %}
    <p>{{ variant_description }}</p>
    {% endif %}
</header>

<section id="overview">
    <h2>1. Overview</h2>
    <p>
        This report examines toy-looking proportions for the {{ variant_label }} comparison
        ({{ primary_conditions_joined }}), testing how event relevance shapes selective attention.
    </p>

    <div class="stats-summary">
        <h4>Analysis Summary</h4>
        <div class="stat-item">
            <span class="stat-label">Total Participants</span>
            <span class="stat-value">{{ total_participants }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Participants Included</span>
            <span class="stat-value">{{ participants_included }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Participants Excluded</span>
            <span class="stat-value">{{ participants_excluded }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Gaze Fixations Analyzed</span>
            <span class="stat-value">{{ total_gaze_fixations }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Conditions Compared</span>
            <span class="stat-value">{{ primary_conditions|join(', ') }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">All Conditions Observed</span>
            <span class="stat-value">{{ full_conditions_joined }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Gaze Fixations (All Conditions)</span>
            <span class="stat-value">{{ total_gaze_fixations_all }}</span>
        </div>
    </div>

    {% if exclusions %}
    <div class="exclusions">
        <h4>Data Exclusions</h4>
        <p>The following participants/trials were excluded from this analysis:</p>
        <ul>
        {% for exclusion in exclusions %}
            <li>{{ exclusion }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</section>

<section id="methods">
    <h2>2. Methods</h2>

    <h3>2.1 Gaze Fixation Definition</h3>
    <p>
        A <strong>gaze fixation</strong> is defined as {{ min_gaze_frames }} or more consecutive frames
        where the infant's gaze remains on the same Area of Interest (AOI). This conservative threshold
        ensures that brief, transient fixations are not counted as sustained attention.
    </p>

    <h3>2.2 Dependent Variable</h3>
    <p>
        The primary dependent variable is the <strong>proportion of total looking time</strong> spent
        on the toy AOI (toy_present or toy_location) within each trial. This proportion is calculated as:
    </p>
    <p style="text-align: center; font-family: 'Courier New', monospace; padding: 10px; background: #f4f4f4; border-radius: 4px;">
        Proportion = (Total duration on toy) / (Total duration on all AOIs)
    </p>

    <h3>2.3 Statistical Tests</h3>
    <p>We performed the following statistical tests:</p>
    <ul>
        <li><strong>Independent samples t-test:</strong> Comparing mean toy-looking proportion between {{ give_conditions|join(', ') }} and {{ hug_conditions|join(', ') }}.</li>
        <li><strong>One-way ANOVA:</strong> Testing age-group differences in toy-looking proportion within the primary cohort (participant-level means).</li>
    </ul>
    <p>
        Statistical significance threshold: alpha = {{ alpha }}.
        Effect sizes are reported using Cohen's d for t-tests and eta-squared for ANOVA.
    </p>

    <p>
        {% if comparison_label %}
            <strong>Active comparison:</strong> {{ comparison_label|replace('_', ' ')|title }}
        {% else %}
            <strong>Active comparison:</strong>
        {% endif %}
        ({{ give_conditions|join(', ') }} vs {{ hug_conditions|join(', ') }}).
    </p>

</section>

<section id="results">
    <h2>3. Results</h2>

    <h3>3.1 Primary Comparison</h3>
    <p>
        Table 1 summarises the configured comparison of {{ primary_conditions_joined }}.
    </p>

    {{ primary_descriptive_table | safe }}

    {% if participant_count_note %}
    <p class="note">{{ participant_count_note }}</p>
    {% endif %}

    <h3>3.2 Main Effect: Condition</h3>

    {% if figure_primary_comparison %}
    <figure>
        <img src="{{ figure_primary_comparison }}" alt="Mean looking time at toy for primary comparison" style="width:50%; height:auto;">
        <figcaption>
            <strong>Figure 1.</strong> Mean proportion of looking time at the toy across {{ primary_conditions_joined }}.
            Error bars represent {{ error_bar_label }}. {{ significance_marker }}
        </figcaption>
    </figure>
    {% endif %}

    {% set ttest_valid = ttest_p is not none %}
    {% set ttest_significant = ttest_valid and (ttest_p < alpha) %}
    <div class="stats-summary">
        <h4>Independent Samples t-Test Results</h4>
        <div class="stat-item">
            <span class="stat-label">t-statistic</span>
            <span class="stat-value {% if ttest_significant %}significant{% else %}not-significant{% endif %}">
                {% if ttest_valid %}
                    t({{ ttest_df|round(1) }}) = {{ ttest_statistic|round(3) }}
                {% else %}
                    N/A
                {% endif %}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">p-value</span>
            <span class="stat-value {% if ttest_significant %}significant{% else %}not-significant{% endif %}">
                {% if ttest_valid %}
                    p = {{ ttest_p|round(3) }}
                {% else %}
                    p = N/A
                {% endif %}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cohen's d (effect size)</span>
            <span class="stat-value">
                {% if cohens_d is not none %}
                    {{ cohens_d|round(3) }}
                {% else %}
                    N/A
                {% endif %}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">95% Confidence Interval</span>
            <span class="stat-value">[{{ ci_lower }}, {{ ci_upper }}]</span>
        </div>
    </div>

    {% if not ttest_valid %}
    <div class="alert alert-info">
        <strong>Test Unavailable:</strong> Not enough participants contributed usable trials in each condition to run the t-test.
    </div>
    {% elif ttest_significant %}
    <div class="alert alert-success">
        <strong>Significant Result:</strong> Infants looked significantly longer at the toy in the
        {{ significant_condition }} condition compared to the {{ other_condition }} condition
        (p {{ p_comparison }} {{ alpha }}, d = {{ cohens_d }}).
    </div>
    {% else %}
    <div class="alert alert-info">
        <strong>Non-Significant Result:</strong> No significant difference was found in toy-looking
        time between {{ significant_condition }} and {{ other_condition }} (p = {{ ttest_p }}).
    </div>
    {% endif %}

    <h3>3.3 Full Condition Landscape</h3>
    <p>
        Context across all observed conditions ({{ full_conditions_joined }}).
    </p>

    {% if figure_full_conditions %}
    <figure>
        <img src="{{ figure_full_conditions }}" alt="Mean looking time at toy across all conditions" style="width:66%; height:auto;">
        <figcaption>
            <strong>Figure 2.</strong> Mean proportion of looking time at the toy across every experimental condition.
        </figcaption>
    </figure>
    {% endif %}

    {{ full_descriptive_table | safe }}

    <h3>3.4 Developmental Analysis</h3>

    {% if figure_duration_by_age %}
    <figure>
        <img src="{{ figure_duration_by_age }}" alt="Mean looking time at toy by age group">
        <figcaption>
            <strong>Figure 3.</strong> Mean proportion of looking time at the toy object across age groups.
            Error bars represent {{ error_bar_label }}.
        </figcaption>
    </figure>
    {% endif %}

    {{ anova_results_table | safe }}

    {% set anova_valid = anova_f_statistic is not none and anova_df1 is not none and anova_df2 is not none %}
    <div class="stats-summary">
        <h4>One-Way ANOVA Results</h4>
        {% if anova_valid %}
        <div class="stat-item">
            <span class="stat-label">F-statistic</span>
            <span class="stat-value {% if anova_p is not none and anova_p < alpha %}significant{% else %}not-significant{% endif %}">
                F({{ anova_df1 }}, {{ anova_df2 }}) = {{ anova_f_statistic|round(3) }}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">p-value</span>
            <span class="stat-value {% if anova_p is not none and anova_p < alpha %}significant{% else %}not-significant{% endif %}">
                p = {{ anova_p|round(3) }}
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Eta-squared</span>
            <span class="stat-value">
                {% if eta_squared is not none %}{{ eta_squared|round(3) }}{% else %}N/A{% endif %}
            </span>
        </div>
        {% else %}
        <div class="stat-item">
            <span class="stat-label">Status</span>
            <span class="stat-value"> {{ assumptions_violated_message or 'Age analysis not available.' }} </span>
        </div>
        {% endif %}
    </div>

    {% if assumptions_violated and assumptions_violated_message %}
    <div class="alert alert-warning">
        <strong>Assumption Check:</strong> {{ assumptions_violated_message }}
    </div>
    {% endif %}
</section>

<section id="interpretation">
    <h2>4. Interpretation</h2>

    <h3>4.1 Theoretical Implications</h3>
    <p>{{ interpretation_text }}</p>

    <h3>4.2 Comparison to Gordon (2003)</h3>
    <p>{{ comparison_to_gordon }}</p>

    <h3>4.3 Limitations and Future Directions</h3>
    <p>{{ limitations }}</p>
</section>

<section id="raw-data" class="no-print">
    <h2>5. Supplementary Data</h2>

    <h3>5.1 Summary Statistics by Participant</h3>
    <details>
        <summary>Click to expand participant-level data</summary>
        {{ participant_summary_table | safe }}
    </details>

    <h3>5.2 Assumptions Testing</h3>
    <details>
        <summary>Click to expand normality and homogeneity tests</summary>
        {{ assumptions_testing_table }}
    </details>
</section>
{% endblock %}
